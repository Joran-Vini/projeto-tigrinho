{% extends "layout.html" %}

{% block title %}
   Roleta 
{% endblock %}

{% block main %}
<div class="container text-center">
    <h1 class="my-4">Roleta</h1>
    
    <p id="saldo-container">
        Saldo Atual: <strong id="saldo">{{ saldo }}</strong> fichas
    </p>

    <div id="mensagem-resultado" style="display: none;">
        <div class="alert" role="alert" id="alert-mensagem"></div>
    </div>

    <div class="roleta-container">
        <div class="ponteiro"></div>
        <div class="roleta-track">
            <div class="roleta" id="roleta">
                <!-- 3 cópias da sequência oficial -->
                {% for _ in range(3) %}
                    <div class="slot zero">0</div>
                    <div class="slot preto">32</div>
                    <div class="slot vermelho">15</div>
                    <div class="slot preto">19</div>
                    <div class="slot vermelho">4</div>
                    <div class="slot preto">21</div>
                    <div class="slot vermelho">2</div>
                    <div class="slot preto">25</div>
                    <div class="slot vermelho">17</div>
                    <div class="slot preto">34</div>
                    <div class="slot vermelho">6</div>
                    <div class="slot preto">27</div>
                    <div class="slot vermelho">13</div>
                    <div class="slot preto">36</div>
                    <div class="slot vermelho">11</div>
                    <div class="slot preto">30</div>
                    <div class="slot vermelho">8</div>
                    <div class="slot preto">23</div>
                    <div class="slot vermelho">10</div>
                    <div class="slot preto">5</div>
                    <div class="slot vermelho">24</div>
                    <div class="slot preto">16</div>
                    <div class="slot vermelho">33</div>
                    <div class="slot preto">1</div>
                    <div class="slot vermelho">20</div>
                    <div class="slot preto">14</div>
                    <div class="slot vermelho">31</div>
                    <div class="slot preto">9</div>
                    <div class="slot vermelho">22</div>
                    <div class="slot preto">18</div>
                    <div class="slot vermelho">29</div>
                    <div class="slot preto">7</div>
                    <div class="slot vermelho">28</div>
                    <div class="slot preto">12</div>
                    <div class="slot vermelho">35</div>
                    <div class="slot preto">3</div>
                    <div class="slot vermelho">26</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <form method="POST" class="my-4" id="formAposta">
        <div class="mb-3">
            <label for="tipo_aposta" class="form-label">Tipo de Aposta</label>
            <select id="tipo_aposta" name="tipo_aposta" class="form-select" required>
                <option value="numero">Número</option>
                <option value="cor">Cor</option>
                <option value="par_impar">Par/Ímpar</option>
                <option value="baixo_alto">Baixo/Alto</option>
            </select>
        </div>

        <div class="mb-3" id="campoAposta">
            <label for="aposta" class="form-label">Escolha</label>
            <div id="aposta-container"></div>
        </div>

        <div class="mb-3">
            <label for="valor_apostado" class="form-label">Valor Apostado</label>
            <input type="number" id="valor_apostado" name="valor_apostado" 
                   class="form-control" min="1" required>
        </div>

        <button type="submit" class="btn btn-primary btn-lg" id="btn-girar">Girar Roleta</button>
    </form>
</div>

<style>
    .roleta-container {
        width: 100%;
        max-width: 800px;
        margin: 2rem auto;
        height: 100px;
        overflow: hidden;
        position: relative;
        border: 3px solid #333;
        border-radius: 10px;
        background: #2c3e50;
    }

    .roleta-track {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .roleta {
        display: flex;
        gap: 15px;
        padding: 15px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        will-change: transform;
    }

    .slot {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        border-radius: 10px;
        color: white;
        flex-shrink: 0;
        box-shadow: 3px 3px 8px rgba(0,0,0,0.3);
    }

    .zero { background: #27ae60; }
    .vermelho { background: #e74c3c; }
    .preto { background: #212529; }

    .ponteiro {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 100%;
        background: #f1c40f;
        z-index: 2;
        box-shadow: 0 0 15px #f1c40f;
    }
</style>

<script>
    // Sistema de Animação Atualizado
    const VOLTAS = 3;
    const SLOTS_POR_COPIA = 37;
    const COPIAS = 3;
    let animacaoAtiva = false;

    function atualizarAposta() {
        const tipo = document.getElementById('tipo_aposta').value;
        const container = document.getElementById('aposta-container');
        
        let html = '';
        switch(tipo) {
            case 'numero':
                html = `<input type="number" class="form-control" 
                         id="aposta" name="aposta" min="0" max="36" required>`;
                break;
            case 'cor':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="vermelho">Vermelho</option>
                          <option value="preto">Preto</option>
                        </select>`;
                break;
            case 'par_impar':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="par">Par</option>
                          <option value="ímpar">Ímpar</option>
                        </select>`;
                break;
            case 'baixo_alto':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="baixo">Baixo (1-18)</option>
                          <option value="alto">Alto (19-36)</option>
                        </select>`;
                break;
        }
        container.innerHTML = html;
    }

    function girarRoleta(numeroSorteado) {
        if(animacaoAtiva) return;
        animacaoAtiva = true;
        
        const roleta = document.getElementById('roleta');
        const btn = document.getElementById('btn-girar');
        btn.disabled = true;

        // 1. Calcular dimensões precisas
        const primeiroSlot = roleta.firstElementChild;
        const estilo = window.getComputedStyle(primeiroSlot);
        const slotWidth = primeiroSlot.offsetWidth + 
                         parseInt(estilo.marginRight) + 
                         parseInt(estilo.marginLeft);

        // 2. Encontrar índice correto
        const index = Array.from(roleta.children)
            .slice(0, SLOTS_POR_COPIA)
            .findIndex(slot => parseInt(slot.textContent) === numeroSorteado);

        if(index === -1) {
            console.error("Número não encontrado:", numeroSorteado);
            animacaoAtiva = false;
            btn.disabled = false;
            return;
        }

        // 3. Cálculo de posição definitivo
        const larguraTotal = SLOTS_POR_COPIA * COPIAS * slotWidth;
        const deslocamentoVirtual = (VOLTAS * SLOTS_POR_COPIA + index) * slotWidth;
        const deslocamentoReal = deslocamentoVirtual % larguraTotal;

        // 4. Reset inteligente
        roleta.style.transition = 'none';
        roleta.style.transform = `translateX(-${deslocamentoReal}px)`;
        void roleta.offsetWidth;

        // 5. Animação controlada
        roleta.style.transition = 'transform 4s cubic-bezier(0.4, 0, 0.2, 1)';
        roleta.style.transform = `translateX(-${deslocamentoVirtual}px)`;

        // 6. Correção final
        roleta.addEventListener('transitionend', () => {
            const posicaoFinal = deslocamentoVirtual % (SLOTS_POR_COPIA * slotWidth);
            roleta.style.transition = 'none';
            roleta.style.transform = `translateX(-${posicaoFinal}px)`;
            void roleta.offsetWidth;
            
            animacaoAtiva = false;
            btn.disabled = false;
        }, { once: true });
    }

    // Event Listeners
    document.getElementById('tipo_aposta').addEventListener('change', atualizarAposta);
    document.addEventListener('DOMContentLoaded', atualizarAposta);

    document.getElementById('formAposta').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(animacaoAtiva) return;

        const formData = new FormData(e.target);
        const btn = document.getElementById('btn-girar');
        btn.disabled = true;

        try {
            const response = await fetch('/roleta', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if(!data.success) throw new Error(data.mensagem);

            document.getElementById('saldo').textContent = data.novo_saldo;
            document.getElementById('alert-mensagem').textContent = data.mensagem;
            document.getElementById('alert-mensagem').className = `alert ${data.message_class}`;
            document.getElementById('mensagem-resultado').style.display = 'block';

            girarRoleta(data.numero_sorteado);

        } catch (error) {
            alert(error.message);
            btn.disabled = false;
        }
    });
</script>

{% endblock %}