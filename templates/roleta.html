{% extends "layout.html" %}

{% block title %}Roleta{% endblock %}

{% block main %}
<div class="container text-center">
    <h1 class="my-4">Double</h1>
    
    <p id="saldo-container">
        Saldo Atual: <strong id="saldo">{{ saldo }}</strong> fichas
    </p>

    <div id="mensagem-resultado" style="display: none;">
        <div class="alert" role="alert" id="alert-mensagem"></div>
    </div>

    <div class="roleta-container">
        <div class="roleta-track" id="roletaTrack">
            <div class="roleta-numbers" id="roletaNumbers">
                <!-- Números gerados dinamicamente -->
            </div>
        </div>
        <div class="roleta-pointer"></div>
    </div>

    <form method="POST" class="my-4" id="formAposta">
        <div class="mb-3">
            <label for="tipo_aposta" class="form-label">Tipo de Aposta</label>
            <select id="tipo_aposta" name="tipo_aposta" class="form-select" required>
                <option value="numero">Número</option>
                <option value="cor">Cor</option>
                <option value="par_impar">Par/Ímpar</option>
                <option value="baixo_alto">Baixo/Alto</option>
            </select>
        </div>

        <div class="mb-3" id="campoAposta">
            <label for="aposta" class="form-label">Escolha</label>
            <div id="aposta-container"></div>
        </div>

        <div class="mb-3">
            <label for="valor_apostado" class="form-label">Valor Apostado</label>
            <input type="number" id="valor_apostado" name="valor_apostado" 
                   class="form-control" min="1" required>
        </div>

        <button type="submit" class="btn btn-primary btn-lg" id="btn-girar">Girar</button>
    </form>
</div>

<style>
    .roleta-container {
        position: relative;
        width: 800px;
        margin: 2rem auto;
        overflow: hidden;
    }

    .roleta-track {
        position: relative;
        height: 100px;
        background: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
    }

    .roleta-numbers {
        display: flex;
        position: absolute;
        left: 0;
        height: 100%;
        transition: transform 4s cubic-bezier(0.33, 0, 0.67, 1);
    }

    .roleta-number {
        width: 80px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
        flex-shrink: 0;
        border-right: 2px solid #333;
    }

    .roleta-pointer {
        position: absolute;
        top: 0;
        left: 50%;
        width: 4px;
        height: 100%;
        background: #f1c40f;
        box-shadow: 0 0 15px #f1c40f;
        z-index: 2;
        transform: translateX(-50%);
    }

    .red { background: #e74c3c; }
    .black { background: #212529; }
</style>

<script>
    const NUMEROS = [
        { numero: 1, cor: 'red' }, { numero: 2, cor: 'black' },
        { numero: 3, cor: 'red' }, { numero: 4, cor: 'black' },
        { numero: 5, cor: 'red' }, { numero: 6, cor: 'black' },
        { numero: 7, cor: 'red' }, { numero: 8, cor: 'black' },
        { numero: 9, cor: 'red' }, { numero: 10, cor: 'black' },
        { numero: 11, cor: 'red' }, { numero: 12, cor: 'black' },
        { numero: 13, cor: 'red' }, { numero: 14, cor: 'black' }
    ];

    const NUM_COPIAS = 3;
    const LARGURA_NUMERO = 80;
    let animacaoAtiva = false;

    function criarEsteira() {
        const container = document.getElementById('roletaNumbers');
        container.innerHTML = '';
        
        for(let i = 0; i < NUM_COPIAS; i++) {
            NUMEROS.forEach(num => {
                const div = document.createElement('div');
                div.className = `roleta-number ${num.cor}`;
                div.textContent = num.numero;
                container.appendChild(div);
            });
        }
    }

    function girarParaNumero(numeroSorteado) {
        if(animacaoAtiva) return;
        animacaoAtiva = true;
        
        console.log("Número recebido do backend:", numeroSorteado);
        
        const index = NUMEROS.findIndex(n => n.numero === numeroSorteado);
        console.log("Índice encontrado:", index);
        
        const posicaoPorVolta = NUMEROS.length * LARGURA_NUMERO;
        const offsetCentral = (document.querySelector('.roleta-container').offsetWidth / 2) - (LARGURA_NUMERO / 2);
        const posicaoAlvo = (posicaoPorVolta * 2) + (index * LARGURA_NUMERO) - offsetCentral;
        
        const esteira = document.getElementById('roletaNumbers');
        esteira.style.transition = 'none';
        esteira.style.transform = `translateX(-${offsetCentral}px)`;
        void esteira.offsetWidth;

        esteira.style.transition = `transform 4s cubic-bezier(0.33, 0, 0.67, 1)`;
        esteira.style.transform = `translateX(-${posicaoAlvo}px)`;

        esteira.addEventListener('transitionend', () => {
            const posicaoFinal = posicaoAlvo % posicaoPorVolta;
            esteira.style.transition = 'none';
            esteira.style.transform = `translateX(-${posicaoFinal}px)`;
            void esteira.offsetWidth;
            
            animacaoAtiva = false;
            document.getElementById('btn-girar').disabled = false;
        }, { once: true });
    }

    function atualizarAposta() {
        const tipo = document.getElementById('tipo_aposta').value;
        const container = document.getElementById('aposta-container');
        
        let html = '';
        switch(tipo) {
            case 'numero':
                html = `<input type="number" class="form-control" 
                         id="aposta" name="aposta" min="1" max="14" required>`;
                break;
            case 'cor':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="red">Vermelho</option>
                          <option value="black">Preto</option>
                        </select>`;
                break;
            case 'par_impar':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="par">Par</option>
                          <option value="ímpar">Ímpar</option>
                        </select>`;
                break;
            case 'baixo_alto':
                html = `<select class="form-select" id="aposta" name="aposta" required>
                          <option value="baixo">Baixo (1-7)</option>
                          <option value="alto">Alto (8-14)</option>
                        </select>`;
                break;
        }
        container.innerHTML = html;
    }

    document.getElementById('tipo_aposta').addEventListener('change', atualizarAposta);
    
    document.getElementById('formAposta').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(animacaoAtiva) return;

        const formData = new FormData(e.target);
        const btn = document.getElementById('btn-girar');
        btn.disabled = true;

        try {
            const response = await fetch('/roleta', {
                method: 'POST',
                body: formData
            });
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Resposta inválida do servidor');
            }

            const data = await response.json();
            
            if(!response.ok || !data.success) {
                throw new Error(data.mensagem || 'Erro desconhecido');
            }

            document.getElementById('saldo').textContent = data.novo_saldo;
            document.getElementById('alert-mensagem').textContent = data.mensagem;
            document.getElementById('alert-mensagem').className = `alert alert-${data.message_class}`;
            document.getElementById('mensagem-resultado').style.display = 'block';

            girarParaNumero(data.numero_sorteado);

        } catch (error) {
            alert(error.message);
            console.error('Erro:', error);
        } finally {
            btn.disabled = false;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        criarEsteira();
        atualizarAposta();
    });
</script>

{% endblock %}